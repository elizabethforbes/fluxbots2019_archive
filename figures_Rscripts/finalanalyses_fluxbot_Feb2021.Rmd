---
title: "finalanalyses_fluxbot_Feb2021"
author: "Elizabeth Forbes"
date: "2/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analyses for fluxbot methods paper, using final dataset

This document contains the analyses we'll use for our fluxbots methods paper. Using the fluxdat_final dataset constructed in "finaldataset_fluxbots_Feb2021" for all analyses.

# basic exploration:
```{r basic}
mean(fluxdat_final$flux_umol_m2_sec)
# [1] 3.971561

min(fluxdat_final$flux_umol_m2_sec)
# -3.893

max(fluxdat_final$flux_umol_m2_sec)
# 43.313

sum(fluxdat_final$flux_umol_m2_sec < 0) # only 330 of dataset's final 'negative' fluxes are less than zero
sum(fluxdat_final$flux_umol_m2_sec < -1) # only 39 of dataset's final 'negative' fluxes are less than negative one

```


# comparisons, night vs. day data
This chunk has some brief comparisons between data collected at night, and during the day, for both flux and ambient CO2 values.
```{r ttests}

# View(fluxdat_final)
library(tidyverse)
library(ggpubr)
library(rstatix)

# want to first compare all midnight data to all high noon data. In all cases, I want to be able to put down bot location as a random effect; so this is going to be more of linear mixed effects model than a straight t-test.
# run a paired (e.g. not independent) two-sample t-test on these data:
midnight <- subset(fluxdat_final, hour == 0) # subset midnight data
noon <- subset(fluxdat_final, hour == 12) # subset noon data
t1 <- t.test(midnight$flux_umol_m2_sec, noon$flux_umol_m2_sec, paired = FALSE) # paired = false bc the two df's are not equal length
t1
# t = 2.0804, df = 874.21, p-value = 0.03778
# 95 percent confidence interval:
#  0.0295203 1.0139279
# mean of midnight: 
#  4.319149  
# mean of noon: 
# 3.797425 
# the two groups are statistically different from each other, ~425-450 observations each for midnight and noon; midnight significantly higher than noon, on average.

# then, I want to compare all daytime data (8am-4pm = day, 8pm-4am = night).
day <- subset(fluxdat_final, hour==8|hour==9|hour==10|hour==11|hour==12|hour==13|hour==14|hour==15|hour==16) #3954 entries
# add col with 'day' marker
day$day_night <- "day"
night <- subset(fluxdat_final, hour==20|hour==21|hour==22|hour==23|hour==0|hour==1|hour==2|hour==3|hour==4) #3753 entries
# add col with 'night' marker
night$day_night <- "night"
t2 <- t.test(night$flux_umol_m2_sec, day$flux_umol_m2_sec, paired = FALSE)
t2
# t = 6.46, df = 7701.4, p-value = 1.111e-10
# 95 percent confidence interval:
#  0.3900214 0.7298435
# mean of night:
# 4.277726  
# mean of day:
# 3.717793 
# the two groups are statistically different from each other, with 3954 observations during the day and 3753 during nighttime hours  Mean nighttime flux higher than mean daytime flux.

```

# Beta exploration
This chunk visualizes the beta values, generated by the linear and quadratic regressions run on each flux observation's raw data, including things like proportions of fluxes that were calculated with L vs Q betas, distributions of beta values, etc.
```{r betas} 
# distribution plots

# distribution of linear betas, fill = herbivore treatment
fluxdat_final %>% 
  ggplot(aes(x=`1st_order_beta_0`, fill=treatment, alpha=0.25))+
  geom_density()+
  theme_classic()

# distribution of quadratic betas, fill = herbivore treatment
fluxdat_final %>% 
  ggplot(aes(x=`2nd_order_beta_0`, fill=treatment, alpha=0.25))+
  geom_density()+
  theme_classic()

# plot exploring the distribution of flux values according to whether it was calculated with a linear or quadratic regression
fluxdat_final %>% 
  ggplot(aes(x=regr, y=flux_umol_m2_sec))+
  geom_boxplot()+
  theme_classic() 

#######
# plot both on same plot; need long form data for that
library(reshape2)
fluxdat_beta_long <- melt(fluxdat_final,
                          id.vars = c("BOTID", "hour"),
                          measure.vars = c("1st_order_beta_0", "2nd_order_beta_0"),
                          variable.name = "beta_type",
                          value.name = "beta_value")
# plot:
ggplot(fluxdat_beta_long, aes(x=beta_value, group=beta_type, fill=beta_type))+
  geom_density(alpha=0.25)+
  facet_wrap(~BOTID)+
  theme_classic()

```

# R2's
This chunk explores the R2s: distribution, which of the methods (quadric or linear) of calculating flux correspond to day vs. night the most often, what the R2s are for those curves, etc. etc. etc..
```{r R2sexploration}

# basic exploration of R2s
mean(fluxdat_final$R2) #0.6488088
median(fluxdat_final$R2) #0.883
min(fluxdat_final$R2) #-24.106
max(fluxdat_final$R2) #0.999

# some more advanced exploration:
sum(fluxdat_final$R2 < 0) # 808 of dataset's final 'negative' R2's are less than zero
sum(fluxdat_final$R2 < -1) # 292 are less than -1

# percentage that are negative?
((sum(fluxdat_final$R2 < 0))/(sum(fluxdat_final$R2)))*100 # 12.34% of the R2s are less than zero
((sum(fluxdat_final$R2 > -0.25 & fluxdat_final$R2 < 0.25))/(sum(fluxdat_final$R2)))*100 # 9.6% of the R2s are sort of clustered around zero
((sum(fluxdat_final$R2 > 0.90))/(sum(fluxdat_final$R2)))*100 # 71% of the R2s are greater than 0.9, Carbone et al. threshold
cor(fluxdat_final$flux_umol_m2_sec, fluxdat_final$R2) # 23.7% correlation between R2 and flux estimate
```

Some basic descriptive stats of fluxbot data:
```{r descriptive_stats}

# mean of fluxbot data, all
mean(fluxdat_final$flux_umol_m2_sec) #3.971561

# median:
median(fluxdat_final$flux_umol_m2_sec) #3.101

# how many clustered around zero?
sum(fluxdat_final$flux_umol_m2_sec > -2 & fluxdat_final$flux_umol_m2_sec < 2) #3259; about 32%

```

ADDITIONAL STATISTICS/EXPLORATION:
The below chunk includes descriptive stats on uncertainty, R2, and the associated fluxes.
```{r}

sum(fluxdat_final$rel_uncertainty*100 > 100) # only 155 of all the relative flux uncertainties are over 100%
fluxdat_final %>%
  filter(rel_uncertainty*100 > 100) %>%
  filter(flux_umol_m2_sec < 0) %>%
  nrow()  # 57 fluxes have both relative flux uncertainty over 100%, AND are less than 0
sum(fluxdat_final$rel_uncertainty*100 > 50) # only 345 of all the relative flux uncertainties are over 50%
sum(fluxdat_final$rel_uncertainty*100 > 20) # only 811 of all the relative flux uncertainties are over 20%

sum(fluxdat_final$R2 < 0) # 808 total R2s are less than zero (out of 10k)
fluxdat_final %>%
  # filter(rel_uncertainty*100 > 100) %>%
  # filter(flux_umol_m2_sec < 0 & flux_umol_m2_sec > -2) %>% # 324 with less than zero flux AND less than zero R2
  # filter(R2 < 0) %>%
  filter(R2 > 0.25) %>%
  # filter(rel_uncertainty*100 > 50) %>%
  nrow()  # 143 fluxes have both relative flux uncertainty over 100%, AND an R2 of less than zero
sum(fluxdat_final$R2 >.9) # 4653 aka 46%
sum(fluxdat_final$R2 >.5) # 8293 aka 83%
sum(fluxdat_final$R2 > .25) # 8885 aka 88%

# of those R2's less than .5, how many have high relative flux uncertainty and how many have low? (aka the 'split' in the data in figure SI7b)
fluxdat_final %>%
  filter(R2 < 0.5) %>%
  # filter(rel_uncertainty*100 < 50) %>%
  filter(rel_uncertainty*100 > 50) %>%
  nrow()
# 1447 total of the 'less good fit' fluxes have low (aka less than 50%) relative flux uncertainty
# 345 of the less good fit fluxes have high (aka greater than 50% relative flux uncertainty)
# the above two numbers add up to the total number of flux estimates with less than .5 R2 values

sum(fluxdat_final$R2 < -1) # 292 total R2s are less than -1 (out of 10k)
sum(fluxdat_final$R2 < -0.5) # 442 total R2s are less than -0.5 (out of 10k), which means half of the total negative ones are between 0 and -0.5, and a little less than half of the rest are between -0.5 and -1.  e.g. the VAST majority are very minutely negative.

sum(fluxdat_final$flux_umol_m2_sec <0.1) # 419 total
sum(fluxdat_final$flux_umol_m2_sec <0) # 330 total
sum(fluxdat_final$flux_umol_m2_sec <0.05) # 372 total

# average flux of those with relative error > 100:
fluxdat_final %>% 
  filter(rel_uncertainty*100 > 100) %>% # select all those rows with relative uncertainty (in percentage) greater than 100
  summarise(m = mean(flux_umol_m2_sec)) # take the mean of the flux for those rows
# 0.01832903
fluxdat_final %>% 
  filter(rel_uncertainty*100 > 100) %>% # select all those rows with relative uncertainty (in percentage) greater than 100
  summarise(max = max(flux_umol_m2_sec)) # take the max of the flux for those rows
# 0.219
fluxdat_final %>% 
  filter(rel_uncertainty*100 > 100) %>% # select all those rows with relative uncertainty (in percentage) greater than 100
  summarise(min = min(flux_umol_m2_sec)) # take the min of the flux for those rows
# -0.344	
fluxdat_final %>% 
  filter(rel_uncertainty*100 > 100) %>% # select all those rows with relative uncertainty (in percentage) greater than 100
  summarise(med = median(flux_umol_m2_sec)) # take the median of the flux for those rows
# 0.024	

# MEAN R2 for linear vs. quadratic regressions
fluxdat_final %>% 
  filter(regr == "L") %>% 
  summarise(m = mean(R2)) #0.4737685
fluxdat_final %>% 
  filter(regr == "Q") %>% 
  summarise(m = mean(R2)) #0.7345329

```